package ml.shifu.shifu.udf;

import ml.shifu.shifu.core.binning.DynamicBinningTest;
import ml.shifu.shifu.core.binning.EqualIntervalBinning;
import ml.shifu.shifu.core.binning.obj.NumBinInfo;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.pig.data.DataBag;
import org.apache.pig.data.DefaultDataBag;
import org.apache.pig.data.Tuple;
import org.apache.pig.data.TupleFactory;
import org.testng.Assert;
import org.testng.annotations.Test;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Random;
import java.util.zip.GZIPInputStream;

/**
 * Created by zhanhu on 7/6/16.
 */
public class DynamicBinningUDFTest {

    @Test
    public void testDynamicBinningUDFTest() throws IOException {

        DynamicBinningUDF inst = new DynamicBinningUDF("LOCAL",
                "src/test/resources/example/cancer-judgement/ModelStore/ModelSet1/ModelConfig.json",
                "src/test/resources/example/cancer-judgement/ModelStore/ModelSet1/ColumnConfig.json");

        List<NumBinInfo> binInfoList = DynamicBinningTest.createNumBinInfos(10000);
        Random rd = new Random(System.currentTimeMillis());

        long startTs = System.currentTimeMillis();

        for (int i = 0; i < 10000; i++) {
            double val = rd.nextDouble() * 200;
            NumBinInfo numBinInfo = inst.binaryLocate(binInfoList, val);
            Assert.assertNotNull(numBinInfo);
        }

        System.out.println("Spend " + (System.currentTimeMillis() - startTs) + "-ms to query binning number according value.");
    }

    @Test
    public void testDynamicBinningUDF2Test() throws IOException {
        DynamicBinningUDF inst = new DynamicBinningUDF("LOCAL",
                "src/test/resources/example/inner_seg1_v15/ModelConfig.json",
                "src/test/resources/example/inner_seg1_v15/ColumnConfig.json");

        String binsData = "-34.09197\u000134.18017393999999\u0001102.45231787999998\u0001170.72446182\u0001238.99660575999997\u0001307.26874969999994\u0001375.5408936399999\u0001443.8130375799999\u0001512.0851815199999\u0001580.3573254599999\u0001648.6294693999998\u0001716.9016133399998\u0001785.1737572799998\u0001853.4459012199998\u0001921.7180451599997\u0001989.9901890999997\u00011058.2623330399997\u00011126.5344769799997\u00011194.8066209199997\u00011263.0787648599996\u00011331.3509087999996\u00011399.6230527399996\u00011467.8951966799996\u00011536.1673406199995\u00011604.4394845599995\u00011672.7116284999995\u00011740.9837724399995\u00011809.2559163799995\u00011877.5280603199994\u00011945.8002042599994\u00012014.0723481999994\u00012082.3444921399996\u00012150.61663608\u00012218.88878002\u00012287.16092396\u00012355.4330679000004\u00012423.7052118400006\u00012491.977355780001\u00012560.249499720001\u00012628.5216436600012\u00012696.7937876000015\u00012765.0659315400017\u00012833.338075480002\u00012901.610219420002\u00012969.8823633600023\u00013038.1545073000025\u00013106.4266512400027\u00013174.698795180003\u00013242.970939120003\u00013311.2430830600033\u00013379.5152270000035\u00013447.7873709400037\u00013516.059514880004\u00013584.331658820004\u00013652.6038027600043\u00013720.8759467000045\u00013789.1480906400047\u00013857.420234580005\u00013925.692378520005\u00013993.9645224600054\u00014062.2366664000056\u00014130.508810340006\u00014198.780954280006\u00014267.053098220006\u00014335.325242160006\u00014403.597386100007\u00014471.869530040007\u00014540.141673980007\u00014608.413817920007\u00014676.685961860007\u00014744.958105800008\u00014813.230249740008\u00014881.502393680008\u00014949.774537620008\u00015018.046681560008\u00015086.318825500009\u00015154.590969440009\u00015222.863113380009\u00015291.135257320009\u00015359.4074012600095\u00015427.67954520001\u00015495.95168914001\u00015564.22383308001\u00015632.49597702001\u00015700.7681209600105\u00015769.040264900011\u00015837.312408840011\u00015905.584552780011\u00015973.856696720011\u00016042.1288406600115\u00016110.400984600012\u00016178.673128540012\u00016246.945272480012\u00016315.217416420012\u00016383.489560360013\u00016451.761704300013\u00016520.033848240013\u00016588.305992180013\u00016656.578136120013\u00016724.850280060014\u00016793.122424000014\u00016861.394567940014\u00016929.666711880014\u00016997.938855820014\u00017066.210999760015\u00017134.483143700015\u00017202.755287640015\u00017271.027431580015\u00017339.299575520015\u00017407.571719460016\u00017475.843863400016\u00017544.116007340016\u00017612.388151280016\u00017680.660295220016\u00017748.932439160017\u00017817.204583100017\u00017885.476727040017\u00017953.748870980017\u00018022.0210149200175\u00018090.293158860018\u00018158.565302800018\u00018226.837446740017\u00018295.109590680016\u00018363.381734620016\u00018431.653878560015\u00018499.926022500014\u00018568.198166440014\u00018636.470310380013\u00018704.742454320012\u00018773.014598260012\u00018841.28674220001\u00018909.55888614001\u00018977.83103008001\u00019046.103174020009\u00019114.375317960008\u00019182.647461900007\u00019250.919605840007\u00019319.191749780006\u00019387.463893720005\u00019455.736037660005\u00019524.008181600004\u00019592.280325540003\u00019660.552469480002\u00019728.824613420002\u00019797.096757360001\u00019865.3689013\u00019933.64104524\u000110001.913189179999\u000110070.185333119998\u000110138.457477059997\u000110206.729620999997\u000110275.001764939996\u000110343.273908879995\u000110411.546052819995\u000110479.818196759994\u000110548.090340699993\u000110616.362484639993\u000110684.634628579992\u000110752.906772519991\u000110821.17891645999\u000110889.45106039999\u000110957.723204339989\u000111025.995348279988\u000111094.267492219988\u000111162.539636159987\u000111230.811780099986\u000111299.083924039986\u000111367.356067979985\u000111435.628211919984\u000111503.900355859983\u000111572.172499799983\u000111640.444643739982\u000111708.716787679981\u000111776.98893161998\u000111845.26107555998\u000111913.53321949998\u000111981.805363439978\u000112050.077507379978\u000112118.349651319977\u000112186.621795259976\u000112254.893939199976\u000112323.166083139975\u000112391.438227079974\u000112459.710371019974\u000112527.982514959973\u000112596.254658899972\u000112664.526802839971\u000112732.79894677997\u000112801.07109071997\u000112869.34323465997\u000112937.615378599969\u000113005.887522539968\u000113074.159666479967\u000113142.431810419966\u000113210.703954359966\u000113278.976098299965\u000113347.248242239964\u000113415.520386179964\u000113483.792530119963\u000113552.064674059962\u000113620.336817999962\u000113688.60896193996\u000113756.88110587996\u000113825.15324981996\u000113893.425393759959\u000113961.697537699958\u000114029.969681639957\u000114098.241825579957\u000114166.513969519956\u000114234.786113459955\u000114303.058257399955\u000114371.330401339954\u000114439.602545279953\u000114507.874689219952\u000114576.146833159952\u000114644.418977099951\u000114712.69112103995\u000114780.96326497995\u000114849.235408919949\u000114917.507552859948\u000114985.779696799947\u000115054.051840739947\u000115122.323984679946\u000115190.596128619945\u000115258.868272559945\u000115327.140416499944\u000115395.412560439943\u000115463.684704379943\u000115531.956848319942\u000115600.228992259941\u000115668.50113619994\u000115736.77328013994\u000115805.045424079939\u000115873.317568019938\u000115941.589711959938\u000116009.861855899937\u000116078.133999839936\u000116146.406143779936\u000116214.678287719935\u000116282.950431659934\u000116351.222575599933\u000116419.494719539933\u000116487.766863479934\u000116556.039007419935\u000116624.311151359936\u000116692.583295299937\u000116760.85543923994\u000116829.12758317994\u000116897.39972711994\u000116965.67187105994\u000117033.944014999943\u000117102.216158939944\u000117170.488302879945\u000117238.760446819946\u000117307.032590759947\u000117375.30473469995\u000117443.57687863995\u000117511.84902257995\u000117580.12116651995\u000117648.393310459953\u000117716.665454399954\u000117784.937598339955\u000117853.209742279956\u000117921.481886219957\u000117989.75403015996\u000118058.02617409996\u000118126.29831803996\u000118194.57046197996\u000118262.842605919963\u000118331.114749859964\u000118399.386893799965\u000118467.659037739966\u000118535.931181679967\u000118604.20332561997\u000118672.47546955997\u000118740.74761349997\u000118809.01975743997\u000118877.291901379973\u000118945.564045319974\u000119013.836189259975\u000119082.108333199976\u000119150.380477139977\u000119218.65262107998\u000119286.92476501998\u000119355.19690895998\u000119423.46905289998\u000119491.741196839983\u000119560.013340779984\u000119628.285484719985\u000119696.557628659986\u000119764.829772599987\u000119833.10191653999\u000119901.37406047999\u000119969.64620441999\u000120037.91834835999\u000120106.190492299993\u000120174.462636239994\u000120242.734780179995\u000120311.006924119996\u000120379.279068059997\u000120447.551212\u000120515.82335594\u000120584.09549988\u000120652.367643820002\u000120720.639787760003\u000120788.911931700004\u000120857.184075640005\u000120925.456219580006\u000120993.728363520007\u000121062.00050746001\u000121130.27265140001\u000121198.54479534001\u000121266.816939280012\u000121335.089083220013\u000121403.361227160014\u000121471.633371100015\u000121539.905515040016\u000121608.177658980017\u000121676.44980292002\u000121744.72194686002\u000121812.99409080002\u000121881.266234740022\u000121949.538378680023\u000122017.810522620024\u000122086.082666560025\u000122154.354810500026\u000122222.626954440027\u000122290.89909838003\u000122359.17124232003\u000122427.44338626003\u000122495.715530200032\u000122563.987674140033\u000122632.259818080034\u000122700.531962020035\u000122768.804105960036\u000122837.076249900038\u000122905.34839384004\u000122973.62053778004\u000123041.89268172004\u000123110.164825660042\u000123178.436969600043\u000123246.709113540044\u000123314.981257480045\u000123383.253401420046\u000123451.525545360048\u000123519.79768930005\u000123588.06983324005\u000123656.34197718005\u000123724.614121120052\u000123792.886265060053\u000123861.158409000054\u000123929.430552940055\u000123997.702696880056\u000124065.974840820058\u000124134.24698476006\u000124202.51912870006\u000124270.79127264006\u000124339.063416580062\u000124407.335560520063\u000124475.607704460064\u000124543.879848400065\u000124612.151992340066\u000124680.424136280068\u000124748.69628022007\u000124816.96842416007\u000124885.24056810007\u000124953.512712040072\u000125021.784855980073\u000125090.056999920074\u000125158.329143860075\u000125226.601287800077\u000125294.873431740078\u000125363.14557568008\u000125431.41771962008\u000125499.68986356008\u000125567.962007500082\u000125636.234151440083\u000125704.506295380084\u000125772.778439320085\u000125841.050583260087\u000125909.322727200088\u000125977.59487114009\u000126045.86701508009\u000126114.13915902009\u000126182.411302960092\u000126250.683446900093\u000126318.955590840094\u000126387.227734780095\u000126455.499878720097\u000126523.772022660098\u000126592.0441666001\u000126660.3163105401\u000126728.5884544801\u000126796.860598420102\u000126865.132742360103\u000126933.404886300104\u000127001.677030240106\u000127069.949174180107\u000127138.221318120108\u000127206.49346206011\u000127274.76560600011\u000127343.03774994011\u000127411.309893880112\u000127479.582037820113\u000127547.854181760114\u000127616.126325700116\u000127684.398469640117\u000127752.670613580118\u000127820.94275752012\u000127889.21490146012\u000127957.48704540012\u000128025.759189340122\u000128094.031333280123\u000128162.303477220124\u000128230.575621160126\u000128298.847765100127\u000128367.119909040128\u000128435.39205298013\u000128503.66419692013\u000128571.93634086013\u000128640.208484800132\u000128708.480628740133\u000128776.752772680135\u000128845.024916620136\u000128913.297060560137\u000128981.569204500138\u000129049.84134844014\u000129118.11349238014\u000129186.38563632014\u000129254.657780260142\u000129322.929924200143\u000129391.202068140145\u000129459.474212080146\u000129527.746356020147\u000129596.018499960148\u000129664.29064390015\u000129732.56278784015\u000129800.83493178015\u000129869.107075720152\u000129937.379219660153\u000130005.651363600155\u000130073.923507540156\u000130142.195651480157\u000130210.467795420158\u000130278.73993936016\u000130347.01208330016\u000130415.28422724016\u000130483.556371180162\u000130551.828515120164\u000130620.100659060165\u000130688.372803000166\u000130756.644946940167\u000130824.917090880168\u000130893.18923482017\u000130961.46137876017\u000131029.73352270017\u000131098.005666640172\u000131166.277810580174\u000131234.549954520175\u000131302.822098460176\u000131371.094242400177\u000131439.366386340178\u000131507.63853028018\u000131575.91067422018\u000131644.18281816018\u000131712.454962100182\u000131780.727106040184\u000131848.999249980185\u000131917.271393920186\u000131985.543537860187\u000132053.815681800188\u000132122.08782574019\u000132190.35996968019\u000132258.63211362019\u000132326.904257560192\u000132395.176401500194\u000132463.448545440195\u000132531.720689380196\u000132599.992833320197\u000132668.264977260198\u000132736.5371212002\u000132804.8092651402\u000132873.081409080194\u000132941.35355302019\u000133009.62569696019\u000133077.89784090019\u000133146.169984840184\u000133214.44212878018\u000133282.71427272018\u000133350.98641666018\u000133419.258560600174\u000133487.53070454017\u000133555.80284848017\u000133624.07499242017\u000133692.347136360164\u000133760.61928030016\u000133828.89142424016\u000133897.163568180156\u000133965.435712120154\u000134033.70785606015\u000134101.98000000015\u000134170.252143940146\u000134238.524287880144\u000134306.79643182014\u000134375.06857576014\u000134443.340719700136\u000134511.61286364013\u000134579.88500758013\u000134648.15715152013\u000134716.429295460126\u000134784.70143940012\u000134852.97358334012\u000134921.24572728012\u000134989.517871220116\u000135057.79001516011\u000135126.06215910011\u000135194.33430304011\u000135262.606446980106\u000135330.8785909201\u000135399.1507348601\u000135467.4228788001\u000135535.695022740096\u000135603.96716668009\u000135672.23931062009\u000135740.51145456009\u000135808.783598500086\u000135877.05574244008\u000135945.32788638008\u000136013.60003032008\u000136081.872174260076\u000136150.14431820007\u000136218.41646214007\u000136286.68860608007\u000136354.960750020065\u000136423.23289396006\u000136491.50503790006\u000136559.77718184006\u000136628.049325780055\u000136696.32146972005\u000136764.59361366005\u000136832.86575760005\u000136901.137901540045\u000136969.41004548004\u000137037.68218942004\u000137105.95433336004\u000137174.226477300035\u000137242.49862124003\u000137310.77076518003\u000137379.04290912003\u000137447.315053060025\u000137515.58719700002\u000137583.85934094002\u000137652.13148488002\u000137720.403628820015\u000137788.67577276001\u000137856.94791670001\u000137925.22006064001\u000137993.492204580005\u000138061.76434852\u000138130.03649246\u000138198.3086364\u000138266.580780339995\u000138334.85292427999\u000138403.12506821999\u000138471.39721215999\u000138539.669356099985\u000138607.94150003998\u000138676.21364397998\u000138744.48578791998\u000138812.757931859975\u000138881.03007579997\u000138949.30221973997\u000139017.57436367997\u000139085.846507619965\u000139154.11865155996\u000139222.39079549996\u000139290.66293943996\u000139358.935083379954\u000139427.20722731995\u000139495.47937125995\u000139563.75151519995\u000139632.023659139944\u000139700.29580307994\u000139768.56794701994\u000139836.84009095994\u000139905.112234899934\u000139973.38437883993\u000140041.65652277993\u000140109.92866671993\u000140178.200810659924\u000140246.47295459992\u000140314.74509853992\u000140383.01724247992\u000140451.289386419914\u000140519.56153035991\u000140587.83367429991\u000140656.10581823991\u000140724.377962179904\u000140792.6501061199\u000140860.9222500599\u000140929.1943939999\u000140997.466537939894\u000141065.73868187989\u000141134.01082581989\u000141202.282969759886\u000141270.555113699884\u000141338.82725763988\u000141407.09940157988\u000141475.371545519876\u000141543.643689459874\u000141611.91583339987\u000141680.18797733987\u000141748.460121279866\u000141816.73226521986\u000141885.00440915986\u000141953.27655309986\u000142021.548697039856\u000142089.82084097985\u000142158.09298491985\u000142226.36512885985\u000142294.637272799846\u000142362.90941673984\u000142431.18156067984\u000142499.45370461984\u000142567.725848559836\u000142635.99799249983\u000142704.27013643983\u000142772.54228037983\u000142840.814424319826\u000142909.08656825982\u000142977.35871219982\u000143045.63085613982\u000143113.903000079816\u000143182.17514401981\u000143250.44728795981\u000143318.71943189981\u000143386.991575839806\u000143455.2637197798\u000143523.5358637198\u000143591.8080076598\u000143660.080151599795\u000143728.35229553979\u000143796.62443947979\u000143864.89658341979\u000143933.168727359785\u000144001.44087129978\u000144069.71301523978\u000144137.98515917978\u000144206.257303119775\u000144274.52944705977\u000144342.80159099977\u000144411.07373493977\u000144479.345878879765\u000144547.61802281976\u000144615.89016675976\u000144684.16231069976\u000144752.434454639755\u000144820.70659857975\u000144888.97874251975\u000144957.25088645975\u000145025.523030399745\u000145093.79517433974\u000145162.06731827974\u000145230.33946221974\u000145298.611606159735\u000145366.88375009973\u000145435.15589403973\u000145503.42803797973\u000145571.700181919725\u000145639.97232585972\u000145708.24446979972\u000145776.51661373972\u000145844.788757679715\u000145913.06090161971\u000145981.33304555971\u000146049.60518949971\u000146117.877333439705\u000146186.1494773797\u000146254.4216213197\u000146322.6937652597\u000146390.965909199695\u000146459.23805313969\u000146527.51019707969\u000146595.78234101969\u000146664.054484959684\u000146732.32662889968\u000146800.59877283968\u000146868.87091677968\u000146937.143060719674\u000147005.41520465967\u000147073.68734859967\u000147141.95949253967\u000147210.231636479664\u000147278.50378041966\u000147346.77592435966\u000147415.04806829966\u000147483.320212239654\u000147551.59235617965\u000147619.86450011965\u000147688.13664405965\u000147756.408787999644\u000147824.68093193964\u000147892.95307587964\u000147961.22521981964\u000148029.497363759634\u000148097.76950769963\u000148166.04165163963\u000148234.31379557963\u000148302.585939519624\u000148370.85808345962\u000148439.13022739962\u000148507.40237133962\u000148575.674515279614\u000148643.94665921961\u000148712.21880315961\u000148780.490947099606\u000148848.763091039604\u000148917.0352349796\u000148985.3073789196\u000149053.579522859596\u000149121.851666799594\u000149190.12381073959\u000149258.39595467959\u000149326.668098619586\u000149394.94024255958\u000149463.21238649958\u000149531.48453043958\u000149599.756674379576\u000149668.02881831957\u000149736.30096225957\u000149804.57310619957\u000149872.845250139566\u000149941.11739407956\u000150009.38953801956\u000150077.66168195956\u000150145.933825899556\u000150214.20596983955\u000150282.47811377955\u000150350.75025771955\u000150419.022401659546\u000150487.29454559954\u000150555.56668953954\u000150623.83883347954\u000150692.110977419536\u000150760.38312135953\u000150828.65526529953\u000150896.92740923953\u000150965.199553179526\u000151033.47169711952\u000151101.74384105952\u000151170.01598499952\u000151238.288128939515\u000151306.56027287951\u000151374.83241681951\u000151443.10456075951\u000151511.376704699505\u000151579.6488486395\u000151647.9209925795\u000151716.1931365195\u000151784.465280459495\u000151852.73742439949\u000151921.00956833949\u000151989.28171227949\u000152057.553856219485\u000152125.82600015948\u000152194.09814409948\u000152262.37028803948\u000152330.642431979475\u000152398.91457591947\u000152467.18671985947\u000152535.45886379947\u000152603.731007739465\u000152672.00315167946\u000152740.27529561946\u000152808.54743955946\u000152876.819583499455\u000152945.09172743945\u000153013.36387137945\u000153081.63601531945\u000153149.908159259445\u000153218.18030319944\u000153286.45244713944\u000153354.72459107944\u000153422.996735019435\u000153491.26887895943\u000153559.54102289943\u000153627.81316683943\u000153696.085310779425\u000153764.35745471942\u000153832.62959865942\u000153900.90174259942\u000153969.173886539415\u000154037.44603047941\u000154105.71817441941\u000154173.99031835941\u000154242.262462299404\u000154310.5346062394\u000154378.8067501794\u000154447.0788941194\u000154515.351038059394\u000154583.62318199939\u000154651.89532593939\u000154720.16746987939\u000154788.439613819384\u000154856.71175775938\u000154924.98390169938\u000154993.25604563938\u000155061.528189579374\u000155129.80033351937\u000155198.07247745937\u000155266.34462139937\u000155334.616765339364\u000155402.88890927936\u000155471.16105321936\u000155539.43319715936\u000155607.705341099354\u000155675.97748503935\u000155744.24962897935\u000155812.52177291935\u000155880.793916859344\u000155949.06606079934\u000156017.33820473934\u000156085.610348679336\u000156153.882492619334\u000156222.15463655933\u000156290.42678049933\u000156358.698924439326\u000156426.971068379324\u000156495.24321231932\u000156563.51535625932\u000156631.787500199316\u000156700.05964413931\u000156768.33178807931\u000156836.60393201931\u000156904.876075959306\u000156973.1482198993\u000157041.4203638393\u000157109.6925077793\u000157177.964651719296\u000157246.23679565929\u000157314.50893959929\u000157382.78108353929\u000157451.053227479286\u000157519.32537141928\u000157587.59751535928\u000157655.86965929928\u000157724.141803239276\u000157792.41394717927\u000157860.68609111927\u000157928.95823505927\u000157997.230378999266\u000158065.50252293926\u000158133.77466687926\u000158202.04681081926\u000158270.318954759256\u000158338.59109869925\u000158406.86324263925\u000158475.13538657925\u000158543.407530519245\u000158611.67967445924\u000158679.95181839924\u000158748.22396233924\u000158816.496106279235\u000158884.76825021923\u000158953.04039415923\u000159021.31253809923\u000159089.584682039225\u000159157.85682597922\u000159226.12896991922\u000159294.40111385922\u000159362.673257799215\u000159430.94540173921\u000159499.21754567921\u000159567.48968961921\u000159635.761833559205\u000159704.0339774992\u000159772.3061214392\u000159840.5782653792\u000159908.850409319195\u000159977.12255325919\u000160045.39469719919\u000160113.66684113919\u000160181.938985079185\u000160250.21112901918\u000160318.48327295918\u000160386.75541689918\u000160455.027560839175\u000160523.29970477917\u000160591.57184871917\u000160659.84399265917\u000160728.116136599165\u000160796.38828053916\u000160864.66042447916\u000160932.93256841916\u000161001.204712359155\u000161069.47685629915\u000161137.74900023915\u000161206.02114417915\u000161274.293288119145\u000161342.56543205914\u000161410.83757599914\u000161479.10971993914\u000161547.381863879134\u000161615.65400781913\u000161683.92615175913\u000161752.19829569913\u000161820.470439639124\u000161888.74258357912\u000161957.01472751912\u000162025.28687145912\u000162093.559015399114\u000162161.83115933911\u000162230.10330327911\u000162298.37544721911\u000162366.647591159104\u000162434.9197350991\u000162503.1918790391\u000162571.4640229791\u000162639.736166919094\u000162708.00831085909\u000162776.28045479909\u000162844.55259873909\u000162912.824742679084\u000162981.09688661908\u000163049.36903055908\u000163117.64117449908\u000163185.913318439074\u000163254.18546237907\u000163322.45760631907\u000163390.729750259066\u000163459.001894199064\u000163527.27403813906\u000163595.54618207906\u000163663.818326019056\u000163732.090469959054\u000163800.36261389905\u000163868.63475783905\u000163936.906901779046\u000164005.179045719044\u000164073.45118965904\u000164141.72333359904\u000164209.995477539036\u000164278.26762147903\u000164346.53976541903\u000164414.81190935903\u000164483.084053299026\u000164551.35619723902\u000164619.62834117902\u000164687.90048511902\u000164756.172629059016\u000164824.44477299901\u000164892.71691693901\u000164960.98906087901\u000165029.261204819006\u000165097.533348759\u000165165.805492699\u000165234.077636639\u000165302.349780578996\u000165370.62192451899\u000165438.89406845899\u000165507.16621239899\u000165575.43835633899\u000165643.71050027899\u000165711.982644219\u000165780.254788159\u000165848.526932099\u000165916.79907603901\u000165985.07121997901\u000166053.34336391902\u000166121.61550785902\u000166189.88765179903\u000166258.15979573903\u000166326.43193967904\u000166394.70408361904\u000166462.97622755905\u000166531.24837149905\u000166599.52051543906\u000166667.79265937906\u000166736.06480331907\u000166804.33694725907\u000166872.60909119908\u000166940.88123513908\u000167009.15337907909\u000167077.42552301909\u000167145.6976669591\u000167213.9698108991\u000167282.2419548391\u000167350.51409877911\u000167418.78624271911\u000167487.05838665912\u000167555.33053059912\u000167623.60267453913\u000167691.87481847913\u000167760.14696241914\u000167828.41910635914\u000167896.69125029915\u000167964.96339423915\u000168033.23553817916\u000168101.50768211916\u000168169.77982605917\u000168238.05197";
        Tuple input = TupleFactory.getInstance().newTuple(4);
        input.set(0, 1);
        input.set(1, createDataBag());
        input.set(2, 1);
        input.set(3, binsData);

        String binsText = (String)inst.exec(input).get(1);
        Assert.assertEquals(10, StringUtils.split(binsText, CalculateStatsUDF.CATEGORY_VAL_SEPARATOR).length);
    }

    private DataBag createDataBag() throws IOException {
        InputStream is = DynamicBinningUDFTest.class.getResourceAsStream("/example/inner_seg1_v15/ars_sample_fields.gz");
        GZIPInputStream gzis = new GZIPInputStream(is);

        DataBag databag = new DefaultDataBag();

        EqualIntervalBinning inst = new EqualIntervalBinning(1000);
        List<String> lines = IOUtils.readLines(gzis);
        for (String record : lines) {
            String[] fields = record.split("\\|");
            inst.addData(fields[0]);

            Tuple tuple = TupleFactory.getInstance().newTuple(4);
            tuple.set(0, 1);
            tuple.set(1, fields[0]);
            tuple.set(2, (fields[1].equals("1") ? Boolean.TRUE : Boolean.FALSE));
            tuple.set(3, 0);

            databag.add(tuple);
        }

        IOUtils.closeQuietly(gzis);
        IOUtils.closeQuietly(is);

        return databag;
    }
}
